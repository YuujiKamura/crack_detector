<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚¯ãƒ©ãƒƒã‚¯å±•é–‹å›³</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: #16213e;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-stats {
            font-size: 12px;
            color: #888;
        }

        /* ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ */
        .camera-section {
            position: relative;
            background: #000;
        }

        #video {
            width: 100%;
            display: block;
        }

        #video.hidden {
            display: none;
        }

        .camera-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 4px solid #e94560;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .switch-camera-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            align-self: center;
        }

        /* ã‚°ãƒªãƒƒãƒ‰é¸æŠ */
        .grid-selector {
            padding: 12px 16px;
            background: #16213e;
            display: flex;
            gap: 8px;
            align-items: center;
            overflow-x: auto;
        }

        .grid-selector label {
            font-size: 14px;
            white-space: nowrap;
        }

        .grid-btn {
            padding: 8px 16px;
            border: 1px solid #e94560;
            background: transparent;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
        }

        .grid-btn.active {
            background: #e94560;
        }

        /* å±•é–‹å›³ */
        .map-section {
            padding: 16px;
        }

        .map-section h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #888;
        }

        .crack-map {
            display: grid;
            gap: 4px;
            background: #0f0f23;
            padding: 8px;
            border-radius: 8px;
        }

        .map-cell {
            aspect-ratio: 1;
            background: #252542;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .map-cell:hover {
            background: #353562;
        }

        .map-cell.selected {
            outline: 3px solid #e94560;
        }

        .map-cell.has-image {
            background: transparent;
        }

        .map-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .map-cell .cell-label {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 10px;
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .map-cell .crack-info {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 10px;
            background: rgba(233, 69, 96, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .map-cell .placeholder {
            color: #555;
            font-size: 24px;
        }

        /* å‡¦ç†ä¸­ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰ */
        #processCanvas {
            display: none;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            flex-direction: column;
        }

        .preview-modal.show {
            display: flex;
        }

        .preview-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .preview-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .preview-actions {
            padding: 16px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-primary {
            background: #e94560;
            color: #fff;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        /* çµ±è¨ˆ */
        .stats-bar {
            padding: 12px 16px;
            background: #16213e;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #e94560;
        }

        .stat-label {
            font-size: 11px;
            color: #888;
        }

        /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .data-section {
            padding: 16px;
            background: #1a1a2e;
        }

        .data-section h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-section h2 .toggle-btn {
            background: #252542;
            border: none;
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¢¨ãƒ†ãƒ¼ãƒ–ãƒ« */
        .spreadsheet-container {
            overflow-x: auto;
            background: #0f0f23;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .spreadsheet {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 600px;
        }

        .spreadsheet th {
            background: #16213e;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #252542;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .spreadsheet th.col-header {
            text-align: center;
            min-width: 60px;
        }

        .spreadsheet td {
            padding: 8px;
            border-bottom: 1px solid #252542;
            vertical-align: middle;
        }

        .spreadsheet tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }

        .spreadsheet .row-header {
            background: #16213e;
            font-weight: 600;
            text-align: center;
            width: 40px;
        }

        .spreadsheet .cell-input {
            width: 100%;
            background: #252542;
            border: 1px solid transparent;
            color: #fff;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .spreadsheet .cell-input:focus {
            outline: none;
            border-color: #e94560;
            background: #353562;
        }

        .spreadsheet .cell-input:hover:not(:focus) {
            background: #353562;
        }

        .spreadsheet .cell-readonly {
            background: transparent;
            color: #888;
            cursor: default;
        }

        .spreadsheet .cell-crack {
            text-align: right;
            font-family: monospace;
        }

        .spreadsheet .cell-crack.high {
            color: #e94560;
            font-weight: bold;
        }

        .spreadsheet .cell-crack.medium {
            color: #ffa726;
        }

        .spreadsheet .cell-crack.low {
            color: #66bb6a;
        }

        .spreadsheet .cell-status {
            text-align: center;
        }

        .spreadsheet .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .spreadsheet .status-badge.captured {
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        .spreadsheet .status-badge.empty {
            background: rgba(136, 136, 136, 0.2);
            color: #888;
        }

        .spreadsheet .thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .spreadsheet .thumbnail:hover {
            transform: scale(1.5);
            z-index: 10;
            position: relative;
        }

        .spreadsheet .no-image {
            color: #555;
            font-size: 11px;
        }

        /* CSVæ“ä½œãƒœã‚¿ãƒ³ */
        .csv-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .csv-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .csv-btn-export {
            background: #e94560;
            color: #fff;
        }

        .csv-btn-export:hover {
            background: #d13a55;
        }

        .csv-btn-import {
            background: #16213e;
            color: #fff;
            border: 1px solid #e94560;
        }

        .csv-btn-import:hover {
            background: #252542;
        }

        .csv-btn-clear {
            background: #333;
            color: #fff;
        }

        .csv-btn-clear:hover {
            background: #444;
        }

        #csvFileInput {
            display: none;
        }

        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
        }

        .summary-card {
            background: #16213e;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #e94560;
        }

        .summary-card .label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        /* æ¡ä»¶ä»˜ãæ›¸å¼ãƒ˜ãƒ«ãƒ— */
        .format-legend {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #888;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .format-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .format-legend .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .format-legend .dot.high { background: #e94560; }
        .format-legend .dot.medium { background: #ffa726; }
        .format-legend .dot.low { background: #66bb6a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ã‚¯ãƒ©ãƒƒã‚¯å±•é–‹å›³</h1>
        <div class="header-stats">
            <span id="photoCount">0</span> / <span id="totalCells">9</span> æšæ’®å½±
        </div>
    </div>

    <div class="camera-section">
        <video id="video" autoplay playsinline></video>
        <div class="camera-overlay">
            <button class="switch-camera-btn" id="switchCamera">â†»</button>
            <button class="capture-btn" id="captureBtn"></button>
        </div>
    </div>

    <div class="grid-selector">
        <label>ã‚°ãƒªãƒƒãƒ‰:</label>
        <button class="grid-btn active" data-grid="3">3Ã—3</button>
        <button class="grid-btn" data-grid="4">4Ã—4</button>
        <button class="grid-btn" data-grid="5">5Ã—5</button>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-value" id="avgCrack">-</span>
            <span class="stat-label">å¹³å‡ã‚¯ãƒ©ãƒƒã‚¯ç‡</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="maxCrack">-</span>
            <span class="stat-label">æœ€å¤§ã‚¯ãƒ©ãƒƒã‚¯ç‡</span>
        </div>
        <div class="stat-item">
            <span class="stat-value" id="totalArea">-</span>
            <span class="stat-label">ç·ã‚¯ãƒ©ãƒƒã‚¯é¢ç©</span>
        </div>
    </div>

    <div class="map-section">
        <h2>å±•é–‹å›³ï¼ˆæ’®å½±ä½ç½®ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠï¼‰</h2>
        <div class="crack-map" id="crackMap"></div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¢¨UIï¼‰ -->
    <div class="data-section">
        <h2>
            ãƒ‡ãƒ¼ã‚¿ç®¡ç†
            <button class="toggle-btn" id="toggleSpreadsheet">è¡¨ç¤º/éè¡¨ç¤º</button>
        </h2>

        <div id="spreadsheetArea">
            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="value" id="summaryTotal">0</div>
                    <div class="label">æ’®å½±æ¸ˆã¿ã‚»ãƒ«</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="summaryAvg">-</div>
                    <div class="label">å¹³å‡ã‚¯ãƒ©ãƒƒã‚¯ç‡</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="summaryMax">-</div>
                    <div class="label">æœ€å¤§ã‚¯ãƒ©ãƒƒã‚¯ç‡</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="summaryMin">-</div>
                    <div class="label">æœ€å°ã‚¯ãƒ©ãƒƒã‚¯ç‡</div>
                </div>
            </div>

            <!-- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ -->
            <div class="spreadsheet-container">
                <table class="spreadsheet" id="dataSpreadsheet">
                    <thead>
                        <tr>
                            <th class="col-header">#</th>
                            <th>ã‚»ãƒ«ä½ç½®</th>
                            <th>çŠ¶æ…‹</th>
                            <th>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th>
                            <th>ã‚¯ãƒ©ãƒƒã‚¯ç‡ (%)</th>
                            <th>è©•ä¾¡</th>
                            <th>ãƒ¡ãƒ¢</th>
                            <th>æ’®å½±æ—¥æ™‚</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheetBody">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>

            <!-- å‡¡ä¾‹ -->
            <div class="format-legend">
                <span><div class="dot high"></div> é«˜ãƒªã‚¹ã‚¯ (5%ä»¥ä¸Š)</span>
                <span><div class="dot medium"></div> ä¸­ãƒªã‚¹ã‚¯ (2-5%)</span>
                <span><div class="dot low"></div> ä½ãƒªã‚¹ã‚¯ (2%æœªæº€)</span>
            </div>

            <!-- CSVæ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="csv-actions">
                <button class="csv-btn csv-btn-export" id="exportCsvBtn">
                    ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <button class="csv-btn csv-btn-import" id="importCsvBtn">
                    ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
                <button class="csv-btn csv-btn-clear" id="clearDataBtn">
                    ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                </button>
                <input type="file" id="csvFileInput" accept=".csv">
            </div>
        </div>
    </div>

    <canvas id="processCanvas"></canvas>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-header">
            <span>æ’®å½±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            <button class="btn btn-secondary" id="closePreview">âœ•</button>
        </div>
        <div class="preview-content">
            <img id="previewImage" src="" alt="preview">
        </div>
        <div class="preview-actions">
            <button class="btn btn-secondary" id="retakeBtn">æ’®ã‚Šç›´ã™</button>
            <button class="btn btn-primary" id="saveBtn">ã“ã®ä½ç½®ã«ä¿å­˜</button>
        </div>
    </div>

    <script>
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            gridSize: 3,
            selectedCell: null,
            cells: {},  // { "0-0": { original: dataUrl, processed: dataUrl, crackPercent: 0, timestamp: Date, note: "", rating: "" } }
            facingMode: 'environment',
            stream: null,
            capturedImage: null,
            spreadsheetVisible: true
        };

        // DOMè¦ç´ 
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const switchCamera = document.getElementById('switchCamera');
        const crackMap = document.getElementById('crackMap');
        const processCanvas = document.getElementById('processCanvas');
        const ctx = processCanvas.getContext('2d');
        const previewModal = document.getElementById('previewModal');
        const previewImage = document.getElementById('previewImage');

        // ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
        async function initCamera() {
            try {
                if (state.stream) {
                    state.stream.getTracks().forEach(track => track.stop());
                }

                state.stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: state.facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                video.srcObject = state.stream;
            } catch (err) {
                console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
            }
        }

        // ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ
        switchCamera.addEventListener('click', () => {
            state.facingMode = state.facingMode === 'environment' ? 'user' : 'environment';
            initCamera();
        });

        // ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        function createGrid() {
            crackMap.innerHTML = '';
            crackMap.style.gridTemplateColumns = `repeat(${state.gridSize}, 1fr)`;

            document.getElementById('totalCells').textContent = state.gridSize * state.gridSize;

            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    const key = `${row}-${col}`;
                    const cellData = state.cells[key];

                    if (cellData) {
                        cell.classList.add('has-image');
                        cell.innerHTML = `
                            <img src="${cellData.processed}" alt="crack">
                            <span class="cell-label">${row+1}-${col+1}</span>
                            <span class="crack-info">${cellData.crackPercent.toFixed(1)}%</span>
                        `;
                    } else {
                        cell.innerHTML = `
                            <span class="placeholder">+</span>
                            <span class="cell-label">${row+1}-${col+1}</span>
                        `;
                    }

                    cell.addEventListener('click', () => selectCell(row, col));
                    crackMap.appendChild(cell);
                }
            }

            updateStats();
        }

        // ã‚»ãƒ«é¸æŠ
        function selectCell(row, col) {
            document.querySelectorAll('.map-cell').forEach(c => c.classList.remove('selected'));

            const key = `${row}-${col}`;
            state.selectedCell = key;

            const cell = document.querySelector(`.map-cell[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add('selected');
        }

        // æ’®å½±
        captureBtn.addEventListener('click', () => {
            if (!state.selectedCell) {
                alert('å…ˆã«å±•é–‹å›³ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            processCanvas.width = video.videoWidth;
            processCanvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            state.capturedImage = processCanvas.toDataURL('image/jpeg', 0.8);
            previewImage.src = state.capturedImage;
            previewModal.classList.add('show');
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‰ã˜ã‚‹
        document.getElementById('closePreview').addEventListener('click', () => {
            previewModal.classList.remove('show');
        });

        document.getElementById('retakeBtn').addEventListener('click', () => {
            previewModal.classList.remove('show');
        });

        // ä¿å­˜ï¼ˆã‚¯ãƒ©ãƒƒã‚¯æ¤œå‡ºä»˜ãï¼‰
        document.getElementById('saveBtn').addEventListener('click', () => {
            const processed = detectCracks(processCanvas);

            state.cells[state.selectedCell] = {
                original: state.capturedImage,
                processed: processed.imageData,
                crackPercent: processed.crackPercent,
                timestamp: new Date().toISOString(),
                note: '',
                rating: getRatingFromPercent(processed.crackPercent)
            };

            previewModal.classList.remove('show');
            createGrid();
            updateSpreadsheet();

            // æ¬¡ã®ã‚»ãƒ«ã‚’è‡ªå‹•é¸æŠ
            autoSelectNextCell();
        });

        // ã‚¯ãƒ©ãƒƒã‚¯ç‡ã‹ã‚‰è©•ä¾¡ã‚’å–å¾—
        function getRatingFromPercent(percent) {
            if (percent >= 5) return 'è¦å¯¾å¿œ';
            if (percent >= 2) return 'çµŒéè¦³å¯Ÿ';
            return 'è‰¯å¥½';
        }

        // ã‚¯ãƒ©ãƒƒã‚¯æ¤œå‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function detectCracks(canvas) {
            const width = canvas.width;
            const height = canvas.height;
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ– + ã‚¨ãƒƒã‚¸æ¤œå‡ºï¼ˆSobelç°¡æ˜“ç‰ˆï¼‰
            const gray = new Uint8Array(width * height);
            const edges = new Uint8Array(width * height);

            // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–
            for (let i = 0; i < data.length; i += 4) {
                gray[i / 4] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }

            // ç°¡æ˜“Sobelãƒ•ã‚£ãƒ«ã‚¿
            let crackPixels = 0;
            const threshold = 30;

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = y * width + x;

                    // Sobel X
                    const gx =
                        -gray[idx - width - 1] + gray[idx - width + 1] +
                        -2 * gray[idx - 1] + 2 * gray[idx + 1] +
                        -gray[idx + width - 1] + gray[idx + width + 1];

                    // Sobel Y
                    const gy =
                        -gray[idx - width - 1] - 2 * gray[idx - width] - gray[idx - width + 1] +
                        gray[idx + width - 1] + 2 * gray[idx + width] + gray[idx + width + 1];

                    const magnitude = Math.sqrt(gx * gx + gy * gy);

                    if (magnitude > threshold) {
                        edges[idx] = 255;
                        crackPixels++;
                    }
                }
            }

            // ã‚¨ãƒƒã‚¸ã‚’èµ¤ã§æç”»
            for (let i = 0; i < edges.length; i++) {
                if (edges[i] === 255) {
                    const pi = i * 4;
                    data[pi] = 255;     // R
                    data[pi + 1] = 50;  // G
                    data[pi + 2] = 50;  // B
                }
            }

            ctx.putImageData(imageData, 0, 0);

            const crackPercent = (crackPixels / (width * height)) * 100;

            return {
                imageData: canvas.toDataURL('image/jpeg', 0.8),
                crackPercent: crackPercent
            };
        }

        // æ¬¡ã®ã‚»ãƒ«ã‚’è‡ªå‹•é¸æŠ
        function autoSelectNextCell() {
            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const key = `${row}-${col}`;
                    if (!state.cells[key]) {
                        selectCell(row, col);
                        return;
                    }
                }
            }
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const values = Object.values(state.cells);
            const count = values.length;

            document.getElementById('photoCount').textContent = count;

            if (count === 0) {
                document.getElementById('avgCrack').textContent = '-';
                document.getElementById('maxCrack').textContent = '-';
                document.getElementById('totalArea').textContent = '-';
                return;
            }

            const percents = values.map(v => v.crackPercent);
            const avg = percents.reduce((a, b) => a + b, 0) / count;
            const max = Math.max(...percents);

            document.getElementById('avgCrack').textContent = avg.toFixed(1) + '%';
            document.getElementById('maxCrack').textContent = max.toFixed(1) + '%';
            document.getElementById('totalArea').textContent = count + 'åŒºç”»';
        }

        // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´
        document.querySelectorAll('.grid-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.grid-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.gridSize = parseInt(btn.dataset.grid);
                state.cells = {};  // ãƒªã‚»ãƒƒãƒˆ
                state.selectedCell = null;
                createGrid();
                updateSpreadsheet();
            });
        });

        // ========== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ©Ÿèƒ½ ==========

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«
        document.getElementById('toggleSpreadsheet').addEventListener('click', () => {
            state.spreadsheetVisible = !state.spreadsheetVisible;
            document.getElementById('spreadsheetArea').style.display =
                state.spreadsheetVisible ? 'block' : 'none';
        });

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°
        function updateSpreadsheet() {
            const tbody = document.getElementById('spreadsheetBody');
            tbody.innerHTML = '';

            const totalCells = state.gridSize * state.gridSize;
            let rowNum = 1;

            // å…¨ã‚»ãƒ«ã‚’ãƒ«ãƒ¼ãƒ—
            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const key = `${row}-${col}`;
                    const cellData = state.cells[key];
                    const tr = document.createElement('tr');

                    // è¡Œç•ªå·
                    const tdNum = document.createElement('td');
                    tdNum.className = 'row-header';
                    tdNum.textContent = rowNum++;
                    tr.appendChild(tdNum);

                    // ã‚»ãƒ«ä½ç½®
                    const tdPos = document.createElement('td');
                    tdPos.textContent = `${row + 1}-${col + 1}`;
                    tr.appendChild(tdPos);

                    // çŠ¶æ…‹
                    const tdStatus = document.createElement('td');
                    tdStatus.className = 'cell-status';
                    if (cellData) {
                        tdStatus.innerHTML = '<span class="status-badge captured">æ’®å½±æ¸ˆ</span>';
                    } else {
                        tdStatus.innerHTML = '<span class="status-badge empty">æœªæ’®å½±</span>';
                    }
                    tr.appendChild(tdStatus);

                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    const tdPreview = document.createElement('td');
                    if (cellData && cellData.processed) {
                        const img = document.createElement('img');
                        img.src = cellData.processed;
                        img.className = 'thumbnail';
                        img.addEventListener('click', () => showImagePreview(cellData.processed));
                        tdPreview.appendChild(img);
                    } else {
                        tdPreview.innerHTML = '<span class="no-image">-</span>';
                    }
                    tr.appendChild(tdPreview);

                    // ã‚¯ãƒ©ãƒƒã‚¯ç‡
                    const tdCrack = document.createElement('td');
                    tdCrack.className = 'cell-crack';
                    if (cellData) {
                        const percent = cellData.crackPercent;
                        tdCrack.textContent = percent.toFixed(2);
                        if (percent >= 5) tdCrack.classList.add('high');
                        else if (percent >= 2) tdCrack.classList.add('medium');
                        else tdCrack.classList.add('low');
                    } else {
                        tdCrack.textContent = '-';
                    }
                    tr.appendChild(tdCrack);

                    // è©•ä¾¡ï¼ˆç·¨é›†å¯èƒ½ï¼‰
                    const tdRating = document.createElement('td');
                    const ratingSelect = document.createElement('select');
                    ratingSelect.className = 'cell-input';
                    ratingSelect.innerHTML = `
                        <option value="">-</option>
                        <option value="è‰¯å¥½">è‰¯å¥½</option>
                        <option value="çµŒéè¦³å¯Ÿ">çµŒéè¦³å¯Ÿ</option>
                        <option value="è¦å¯¾å¿œ">è¦å¯¾å¿œ</option>
                    `;
                    ratingSelect.value = cellData?.rating || '';
                    ratingSelect.addEventListener('change', () => {
                        if (state.cells[key]) {
                            state.cells[key].rating = ratingSelect.value;
                        }
                    });
                    tdRating.appendChild(ratingSelect);
                    tr.appendChild(tdRating);

                    // ãƒ¡ãƒ¢ï¼ˆç·¨é›†å¯èƒ½ï¼‰
                    const tdNote = document.createElement('td');
                    const noteInput = document.createElement('input');
                    noteInput.type = 'text';
                    noteInput.className = 'cell-input';
                    noteInput.placeholder = 'ãƒ¡ãƒ¢ã‚’å…¥åŠ›...';
                    noteInput.value = cellData?.note || '';
                    noteInput.addEventListener('change', () => {
                        if (state.cells[key]) {
                            state.cells[key].note = noteInput.value;
                        }
                    });
                    tdNote.appendChild(noteInput);
                    tr.appendChild(tdNote);

                    // æ’®å½±æ—¥æ™‚
                    const tdTime = document.createElement('td');
                    if (cellData && cellData.timestamp) {
                        const date = new Date(cellData.timestamp);
                        tdTime.textContent = date.toLocaleString('ja-JP', {
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else {
                        tdTime.textContent = '-';
                    }
                    tr.appendChild(tdTime);

                    tbody.appendChild(tr);
                }
            }

            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            updateSpreadsheetSummary();
        }

        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateSpreadsheetSummary() {
            const values = Object.values(state.cells);
            const count = values.length;

            document.getElementById('summaryTotal').textContent = count;

            if (count === 0) {
                document.getElementById('summaryAvg').textContent = '-';
                document.getElementById('summaryMax').textContent = '-';
                document.getElementById('summaryMin').textContent = '-';
                return;
            }

            const percents = values.map(v => v.crackPercent);
            const avg = percents.reduce((a, b) => a + b, 0) / count;
            const max = Math.max(...percents);
            const min = Math.min(...percents);

            document.getElementById('summaryAvg').textContent = avg.toFixed(1) + '%';
            document.getElementById('summaryMax').textContent = max.toFixed(1) + '%';
            document.getElementById('summaryMin').textContent = min.toFixed(1) + '%';
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function showImagePreview(imageUrl) {
            previewImage.src = imageUrl;
            previewModal.classList.add('show');
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('retakeBtn').textContent = 'é–‰ã˜ã‚‹';
        }

        // ========== CSVæ©Ÿèƒ½ ==========

        // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            const rows = [];

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            rows.push(['ã‚»ãƒ«ä½ç½®', 'è¡Œ', 'åˆ—', 'çŠ¶æ…‹', 'ã‚¯ãƒ©ãƒƒã‚¯ç‡(%)', 'è©•ä¾¡', 'ãƒ¡ãƒ¢', 'æ’®å½±æ—¥æ™‚'].join(','));

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const key = `${row}-${col}`;
                    const cellData = state.cells[key];

                    const rowData = [
                        `${row + 1}-${col + 1}`,
                        row + 1,
                        col + 1,
                        cellData ? 'æ’®å½±æ¸ˆ' : 'æœªæ’®å½±',
                        cellData ? cellData.crackPercent.toFixed(2) : '',
                        cellData?.rating || '',
                        `"${(cellData?.note || '').replace(/"/g, '""')}"`,
                        cellData?.timestamp ? new Date(cellData.timestamp).toLocaleString('ja-JP') : ''
                    ];

                    rows.push(rowData.join(','));
                }
            }

            // BOMä»˜ãUTF-8ã§CSVã‚’ç”Ÿæˆ
            const bom = '\uFEFF';
            const csvContent = bom + rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().slice(0, 10);
            link.download = `crack_data_${timestamp}.csv`;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
        });

        // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        document.getElementById('importCsvBtn').addEventListener('click', () => {
            document.getElementById('csvFileInput').click();
        });

        document.getElementById('csvFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const text = event.target.result;
                    const lines = text.split('\n').filter(line => line.trim());

                    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    for (let i = 1; i < lines.length; i++) {
                        const cols = parseCSVLine(lines[i]);
                        if (cols.length < 6) continue;

                        const position = cols[0]; // "1-1" format
                        const [rowStr, colStr] = position.split('-');
                        const row = parseInt(rowStr) - 1;
                        const col = parseInt(colStr) - 1;
                        const key = `${row}-${col}`;

                        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿æ›´æ–°ï¼ˆç”»åƒãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰
                        if (state.cells[key]) {
                            state.cells[key].rating = cols[5] || state.cells[key].rating;
                            state.cells[key].note = cols[6]?.replace(/^"|"$/g, '').replace(/""/g, '"') || '';
                        }
                    }

                    updateSpreadsheet();
                    alert('CSVãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                } catch (err) {
                    console.error('CSV parse error:', err);
                    alert('CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // ãƒªã‚»ãƒƒãƒˆ
        });

        // CSVè¡Œã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆå¼•ç”¨ç¬¦å¯¾å¿œï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (inQuotes) {
                    if (char === '"') {
                        if (line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        current += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === ',') {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
            }
            result.push(current);
            return result;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        document.getElementById('clearDataBtn').addEventListener('click', () => {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                state.cells = {};
                state.selectedCell = null;
                createGrid();
                updateSpreadsheet();
                selectCell(0, 0);
            }
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('retakeBtn').addEventListener('click', () => {
            document.getElementById('saveBtn').style.display = '';
            document.getElementById('retakeBtn').textContent = 'æ’®ã‚Šç›´ã™';
        });

        // åˆæœŸåŒ–
        initCamera();
        createGrid();
        updateSpreadsheet();
        selectCell(0, 0);  // æœ€åˆã®ã‚»ãƒ«ã‚’é¸æŠ
    </script>
</body>
</html>
