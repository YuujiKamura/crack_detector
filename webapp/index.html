<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚¯ãƒ©ãƒƒã‚¯å±•é–‹å›³</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: #16213e;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: #252542;
            border: none;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .header-btn:hover {
            background: #353562;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-nav {
            display: flex;
            background: #16213e;
            border-bottom: 2px solid #252542;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: #fff;
            background: #252542;
            border-bottom: 2px solid #e94560;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 300;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-modal.show {
            display: block;
        }

        .settings-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-group {
            background: #16213e;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .settings-group h3 {
            font-size: 14px;
            color: #e94560;
            margin-bottom: 12px;
        }

        .settings-group label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 6px;
        }

        .settings-group input {
            width: 100%;
            padding: 10px;
            background: #252542;
            border: 1px solid #353562;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        .settings-group input:focus {
            outline: none;
            border-color: #e94560;
        }

        .settings-group .hint {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
        }

        /* ã‚«ãƒ¡ãƒ©/ç”»åƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .capture-section {
            position: relative;
            background: #000;
        }

        #video, #capturedCanvas {
            width: 100%;
            display: block;
        }

        #capturedCanvas {
            display: none;
        }

        .capture-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #fff;
            border: 4px solid #e94560;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .switch-camera-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            align-self: center;
        }

        /* 4ç‚¹é¸æŠã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .perspective-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .perspective-overlay.active {
            pointer-events: auto;
        }

        .corner-point {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #e94560;
            border: 3px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .corner-point:active {
            cursor: grabbing;
        }

        .perspective-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .action-panel {
            padding: 12px 16px;
            background: #16213e;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn-primary {
            background: #e94560;
            color: #fff;
        }

        .action-btn-secondary {
            background: #252542;
            color: #fff;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .status-bar {
            padding: 8px 16px;
            background: #0f0f23;
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-bar .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid #333;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .data-section {
            padding: 16px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .summary-card {
            background: #16213e;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #e94560;
        }

        .summary-card .label {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .spreadsheet-container {
            overflow-x: auto;
            background: #0f0f23;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .spreadsheet {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 600px;
        }

        .spreadsheet th {
            background: #16213e;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #252542;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .spreadsheet td {
            padding: 8px;
            border-bottom: 1px solid #252542;
            vertical-align: middle;
        }

        .spreadsheet tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }

        .spreadsheet .row-header {
            background: #16213e;
            font-weight: 600;
            text-align: center;
            width: 40px;
        }

        .spreadsheet .cell-input {
            width: 100%;
            background: #252542;
            border: 1px solid transparent;
            color: #fff;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .spreadsheet .cell-input:focus {
            outline: none;
            border-color: #e94560;
        }

        .spreadsheet .cell-crack {
            text-align: right;
            font-family: monospace;
        }

        .spreadsheet .cell-crack.high { color: #e94560; font-weight: bold; }
        .spreadsheet .cell-crack.medium { color: #ffa726; }
        .spreadsheet .cell-crack.low { color: #66bb6a; }

        .spreadsheet .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        .spreadsheet .status-badge.captured {
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
        }

        .spreadsheet .status-badge.empty {
            background: rgba(136, 136, 136, 0.2);
            color: #888;
        }

        .spreadsheet .thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        /* CSVæ“ä½œ */
        .csv-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .csv-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .csv-btn-export { background: #e94560; color: #fff; }
        .csv-btn-import { background: #16213e; color: #fff; border: 1px solid #e94560; }
        .csv-btn-clear { background: #333; color: #fff; }

        #csvFileInput { display: none; }

        .format-legend {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: #888;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .format-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .format-legend .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .format-legend .dot.high { background: #e94560; }
        .format-legend .dot.medium { background: #ffa726; }
        .format-legend .dot.low { background: #66bb6a; }

        /* ã‚°ãƒªãƒƒãƒ‰é¸æŠ */
        .grid-selector {
            padding: 12px 16px;
            background: #0f0f23;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .grid-selector label {
            font-size: 14px;
        }

        .grid-btn {
            padding: 8px 16px;
            border: 1px solid #e94560;
            background: transparent;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
        }

        .grid-btn.active {
            background: #e94560;
        }

        /* å±•é–‹å›³ */
        .crack-map {
            display: grid;
            gap: 4px;
            background: #0f0f23;
            padding: 8px;
            border-radius: 8px;
            margin: 16px;
        }

        .map-cell {
            aspect-ratio: 1;
            background: #252542;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-cell.selected {
            outline: 3px solid #e94560;
        }

        .map-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .map-cell .cell-label {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 10px;
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .map-cell .crack-info {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 10px;
            background: rgba(233, 69, 96, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .map-cell .placeholder {
            color: #555;
            font-size: 24px;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            flex-direction: column;
        }

        .preview-modal.show {
            display: flex;
        }

        .preview-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .preview-content img, .preview-content canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .preview-actions {
            padding: 16px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-primary { background: #e94560; color: #fff; }
        .btn-secondary { background: #333; color: #fff; }

        /* éè¡¨ç¤º */
        #processCanvas { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ã‚¯ãƒ©ãƒƒã‚¯å±•é–‹å›³</h1>
        <div class="header-actions">
            <button class="header-btn" id="settingsBtn">âš™ï¸ è¨­å®š</button>
        </div>
    </div>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="data">ğŸ“Š ãƒ‡ãƒ¼ã‚¿</button>
        <button class="tab-btn" data-tab="capture">ğŸ“· æ’®å½±</button>
        <button class="tab-btn" data-tab="map">ğŸ—ºï¸ å±•é–‹å›³</button>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ã‚¿ãƒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ -->
    <div class="tab-content active" id="tab-data">
        <div class="data-section">
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="value" id="summaryTotal">0</div>
                    <div class="label">æ’®å½±æ¸ˆã¿ã‚»ãƒ«</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="summaryAvg">-</div>
                    <div class="label">å¹³å‡ã‚¯ãƒ©ãƒƒã‚¯ç‡</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="summaryMax">-</div>
                    <div class="label">æœ€å¤§ã‚¯ãƒ©ãƒƒã‚¯ç‡</div>
                </div>
                <div class="summary-card">
                    <div class="value" id="summaryMin">-</div>
                    <div class="label">æœ€å°ã‚¯ãƒ©ãƒƒã‚¯ç‡</div>
                </div>
            </div>

            <div class="spreadsheet-container">
                <table class="spreadsheet" id="dataSpreadsheet">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ã‚»ãƒ«ä½ç½®</th>
                            <th>çŠ¶æ…‹</th>
                            <th>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</th>
                            <th>ã‚¯ãƒ©ãƒƒã‚¯ç‡ (%)</th>
                            <th>è©•ä¾¡</th>
                            <th>ãƒ¡ãƒ¢</th>
                            <th>æ’®å½±æ—¥æ™‚</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsheetBody"></tbody>
                </table>
            </div>

            <div class="format-legend">
                <span><div class="dot high"></div> é«˜ãƒªã‚¹ã‚¯ (5%ä»¥ä¸Š)</span>
                <span><div class="dot medium"></div> ä¸­ãƒªã‚¹ã‚¯ (2-5%)</span>
                <span><div class="dot low"></div> ä½ãƒªã‚¹ã‚¯ (2%æœªæº€)</span>
            </div>

            <div class="csv-actions">
                <button class="csv-btn csv-btn-export" id="exportCsvBtn">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="csv-btn csv-btn-import" id="importCsvBtn">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="csv-btn csv-btn-clear" id="clearDataBtn">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                <input type="file" id="csvFileInput" accept=".csv">
            </div>
        </div>
    </div>

    <!-- æ’®å½±ã‚¿ãƒ– -->
    <div class="tab-content" id="tab-capture">
        <div class="capture-section">
            <video id="video" autoplay playsinline></video>
            <canvas id="capturedCanvas"></canvas>

            <!-- ãƒ‘ãƒ¼ã‚¹è£œæ­£ç”¨4ç‚¹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div class="perspective-overlay" id="perspectiveOverlay">
                <svg class="perspective-lines" id="perspectiveLines">
                    <polygon id="perspectivePolygon" fill="rgba(233,69,96,0.2)" stroke="#e94560" stroke-width="2"/>
                </svg>
                <div class="corner-point" id="corner0" data-index="0">1</div>
                <div class="corner-point" id="corner1" data-index="1">2</div>
                <div class="corner-point" id="corner2" data-index="2">3</div>
                <div class="corner-point" id="corner3" data-index="3">4</div>
            </div>

            <div class="capture-overlay" id="captureOverlay">
                <button class="switch-camera-btn" id="switchCamera">â†»</button>
                <button class="capture-btn" id="captureBtn"></button>
            </div>
        </div>

        <div class="status-bar" id="statusBar">
            <span>ã‚»ãƒ«ã‚’é¸æŠã—ã¦æ’®å½±ã—ã¦ãã ã•ã„</span>
        </div>

        <div class="action-panel" id="actionPanel">
            <button class="action-btn action-btn-secondary" id="detectGroundBtn">ğŸ¤– åœ°é¢ã‚’è‡ªå‹•æ¤œå‡º</button>
            <button class="action-btn action-btn-secondary" id="resetPointsBtn">â†©ï¸ 4ç‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="action-btn action-btn-primary" id="applyTransformBtn" disabled>âœ“ è£œæ­£ã‚’é©ç”¨</button>
        </div>

        <div class="grid-selector">
            <label>ã‚°ãƒªãƒƒãƒ‰:</label>
            <button class="grid-btn active" data-grid="3">3Ã—3</button>
            <button class="grid-btn" data-grid="4">4Ã—4</button>
            <button class="grid-btn" data-grid="5">5Ã—5</button>
        </div>
    </div>

    <!-- å±•é–‹å›³ã‚¿ãƒ– -->
    <div class="tab-content" id="tab-map">
        <div class="crack-map" id="crackMap"></div>
    </div>

    <!-- å‡¦ç†ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <canvas id="processCanvas"></canvas>
    <canvas id="transformCanvas" style="display:none;"></canvas>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-header">
            <span id="previewTitle">æ’®å½±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
            <button class="btn btn-secondary" id="closePreview">âœ•</button>
        </div>
        <div class="preview-content">
            <img id="previewImage" src="" alt="preview">
        </div>
        <div class="preview-actions">
            <button class="btn btn-secondary" id="retakeBtn">æ’®ã‚Šç›´ã™</button>
            <button class="btn btn-primary" id="saveBtn">ã“ã®ä½ç½®ã«ä¿å­˜</button>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>è¨­å®š</h2>
                <button class="btn btn-secondary" id="closeSettings">âœ•</button>
            </div>

            <div class="settings-group">
                <h3>Gemini API</h3>
                <label>APIã‚­ãƒ¼</label>
                <input type="password" id="geminiApiKey" placeholder="AIzaSy...">
                <div class="hint">Google AI Studioã§APIã‚­ãƒ¼ã‚’å–å¾—: <a href="https://aistudio.google.com/apikey" target="_blank" style="color:#e94560;">aistudio.google.com</a></div>
            </div>

            <div class="settings-group">
                <h3>æ¤œå‡ºè¨­å®š</h3>
                <label>ã‚¯ãƒ©ãƒƒã‚¯æ¤œå‡ºã—ãã„å€¤ (0-100)</label>
                <input type="number" id="crackThreshold" value="30" min="0" max="100">
                <div class="hint">å€¤ãŒä½ã„ã»ã©æ•æ„Ÿã«æ¤œå‡ºã—ã¾ã™</div>
            </div>

            <button class="btn btn-primary" id="saveSettings" style="width:100%;margin-top:16px;">ä¿å­˜</button>
        </div>
    </div>

    <script>
        // ========== çŠ¶æ…‹ç®¡ç† ==========
        const state = {
            gridSize: 3,
            selectedCell: null,
            cells: {},
            facingMode: 'environment',
            stream: null,
            capturedImage: null,
            isCapturing: false,
            perspectivePoints: [
                { x: 20, y: 20 },
                { x: 80, y: 20 },
                { x: 80, y: 80 },
                { x: 20, y: 80 }
            ],
            isPerspectiveMode: false,
            settings: {
                geminiApiKey: '',
                crackThreshold: 30
            }
        };

        // ========== DOMè¦ç´  ==========
        const video = document.getElementById('video');
        const capturedCanvas = document.getElementById('capturedCanvas');
        const capturedCtx = capturedCanvas.getContext('2d');
        const processCanvas = document.getElementById('processCanvas');
        const processCtx = processCanvas.getContext('2d');
        const transformCanvas = document.getElementById('transformCanvas');
        const transformCtx = transformCanvas.getContext('2d');
        const previewModal = document.getElementById('previewModal');
        const previewImage = document.getElementById('previewImage');
        const perspectiveOverlay = document.getElementById('perspectiveOverlay');
        const statusBar = document.getElementById('statusBar');

        // ========== åˆæœŸåŒ– ==========
        function init() {
            loadSettings();
            initCamera();
            createGrid();
            updateSpreadsheet();
            selectCell(0, 0);
            setupEventListeners();
            initPerspectivePoints();
        }

        function loadSettings() {
            const saved = localStorage.getItem('crackDetectorSettings');
            if (saved) {
                state.settings = JSON.parse(saved);
                document.getElementById('geminiApiKey').value = state.settings.geminiApiKey || '';
                document.getElementById('crackThreshold').value = state.settings.crackThreshold || 30;
            }
        }

        function saveSettings() {
            state.settings.geminiApiKey = document.getElementById('geminiApiKey').value;
            state.settings.crackThreshold = parseInt(document.getElementById('crackThreshold').value) || 30;
            localStorage.setItem('crackDetectorSettings', JSON.stringify(state.settings));
        }

        // ========== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ==========
        function setupEventListeners() {
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
                });
            });

            // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.add('show');
            });
            document.getElementById('closeSettings').addEventListener('click', () => {
                document.getElementById('settingsModal').classList.remove('show');
            });
            document.getElementById('saveSettings').addEventListener('click', () => {
                saveSettings();
                document.getElementById('settingsModal').classList.remove('show');
                showStatus('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            });

            // ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('switchCamera').addEventListener('click', () => {
                state.facingMode = state.facingMode === 'environment' ? 'user' : 'environment';
                initCamera();
            });

            // æ’®å½±
            document.getElementById('captureBtn').addEventListener('click', captureImage);

            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º
            document.querySelectorAll('.grid-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.grid-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.gridSize = parseInt(btn.dataset.grid);
                    state.cells = {};
                    state.selectedCell = null;
                    createGrid();
                    updateSpreadsheet();
                    selectCell(0, 0);
                });
            });

            // ãƒ‘ãƒ¼ã‚¹è£œæ­£
            document.getElementById('detectGroundBtn').addEventListener('click', detectGroundWithAI);
            document.getElementById('resetPointsBtn').addEventListener('click', resetPerspectivePoints);
            document.getElementById('applyTransformBtn').addEventListener('click', applyPerspectiveTransform);

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
            document.getElementById('closePreview').addEventListener('click', closePreview);
            document.getElementById('retakeBtn').addEventListener('click', closePreview);
            document.getElementById('saveBtn').addEventListener('click', saveImage);

            // CSVæ“ä½œ
            document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
            document.getElementById('importCsvBtn').addEventListener('click', () => document.getElementById('csvFileInput').click());
            document.getElementById('csvFileInput').addEventListener('change', importCSV);
            document.getElementById('clearDataBtn').addEventListener('click', clearData);
        }

        // ========== ã‚«ãƒ¡ãƒ© ==========
        async function initCamera() {
            try {
                if (state.stream) {
                    state.stream.getTracks().forEach(track => track.stop());
                }
                state.stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: state.facingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = state.stream;
                video.style.display = 'block';
                capturedCanvas.style.display = 'none';
                document.getElementById('captureOverlay').style.display = 'flex';
                state.isCapturing = false;
            } catch (err) {
                console.error('Camera error:', err);
                showStatus('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', true);
            }
        }

        // ========== æ’®å½± ==========
        function captureImage() {
            if (!state.selectedCell) {
                showStatus('å…ˆã«å±•é–‹å›³ã§ã‚»ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
                return;
            }

            capturedCanvas.width = video.videoWidth;
            capturedCanvas.height = video.videoHeight;
            capturedCtx.drawImage(video, 0, 0);

            video.style.display = 'none';
            capturedCanvas.style.display = 'block';
            document.getElementById('captureOverlay').style.display = 'none';
            perspectiveOverlay.classList.add('active');

            state.isCapturing = true;
            state.capturedImage = capturedCanvas.toDataURL('image/jpeg', 0.9);

            initPerspectivePoints();
            document.getElementById('applyTransformBtn').disabled = false;
            showStatus('4ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åœ°é¢ç¯„å›²ã‚’èª¿æ•´ã—ã¦ãã ã•ã„');
        }

        // ========== ãƒ‘ãƒ¼ã‚¹è£œæ­£ ==========
        function initPerspectivePoints() {
            const rect = capturedCanvas.getBoundingClientRect();
            const w = rect.width;
            const h = rect.height;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆç”»åƒã®å°‘ã—å†…å´ï¼‰
            state.perspectivePoints = [
                { x: w * 0.15, y: h * 0.15 },
                { x: w * 0.85, y: h * 0.15 },
                { x: w * 0.85, y: h * 0.85 },
                { x: w * 0.15, y: h * 0.85 }
            ];
            updatePerspectiveOverlay();
            setupCornerDrag();
        }

        function updatePerspectiveOverlay() {
            const points = state.perspectivePoints;
            for (let i = 0; i < 4; i++) {
                const corner = document.getElementById(`corner${i}`);
                corner.style.left = `${points[i].x}px`;
                corner.style.top = `${points[i].y}px`;
            }

            const polygon = document.getElementById('perspectivePolygon');
            const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
            polygon.setAttribute('points', pointsStr);
        }

        function setupCornerDrag() {
            for (let i = 0; i < 4; i++) {
                const corner = document.getElementById(`corner${i}`);
                let isDragging = false;

                corner.addEventListener('mousedown', startDrag);
                corner.addEventListener('touchstart', startDrag, { passive: false });

                function startDrag(e) {
                    e.preventDefault();
                    isDragging = true;
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('touchmove', drag, { passive: false });
                    document.addEventListener('mouseup', stopDrag);
                    document.addEventListener('touchend', stopDrag);
                }

                function drag(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    const rect = perspectiveOverlay.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    state.perspectivePoints[i] = {
                        x: Math.max(0, Math.min(rect.width, clientX - rect.left)),
                        y: Math.max(0, Math.min(rect.height, clientY - rect.top))
                    };
                    updatePerspectiveOverlay();
                }

                function stopDrag() {
                    isDragging = false;
                    document.removeEventListener('mousemove', drag);
                    document.removeEventListener('touchmove', drag);
                    document.removeEventListener('mouseup', stopDrag);
                    document.removeEventListener('touchend', stopDrag);
                }
            }
        }

        function resetPerspectivePoints() {
            initPerspectivePoints();
            showStatus('4ç‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        async function detectGroundWithAI() {
            if (!state.settings.geminiApiKey) {
                showStatus('è¨­å®šã§Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            if (!state.capturedImage) {
                showStatus('å…ˆã«ç”»åƒã‚’æ’®å½±ã—ã¦ãã ã•ã„', true);
                return;
            }

            showStatus('ğŸ¤– AIãŒåœ°é¢ã‚’æ¤œå‡ºä¸­...', false, true);

            try {
                const base64Image = state.capturedImage.split(',')[1];
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${state.settings.geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: `ã“ã®ç”»åƒã‹ã‚‰åœ°é¢ãƒ»åºŠé¢ã®å››éš…ã®åº§æ¨™ã‚’æ¤œå‡ºã—ã¦ãã ã•ã„ã€‚
ç”»åƒã¯ãƒ‘ãƒ¼ã‚¹ï¼ˆé è¿‘æ³•ï¼‰ãŒã‹ã‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
åœ°é¢ã¨æ€ã‚ã‚Œã‚‹çŸ©å½¢é ˜åŸŸã®4ã¤ã®è§’ã®åº§æ¨™ã‚’ã€å·¦ä¸Šã‹ã‚‰æ™‚è¨ˆå›ã‚Šã®é †åºã§è¿”ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
{"corners": [{"x": 0.15, "y": 0.20}, {"x": 0.85, "y": 0.18}, {"x": 0.90, "y": 0.85}, {"x": 0.10, "y": 0.88}]}

åº§æ¨™ã¯ç”»åƒã®å¹…ãƒ»é«˜ã•ã«å¯¾ã™ã‚‹å‰²åˆï¼ˆ0.0ã€œ1.0ï¼‰ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
JSONã®ã¿ã‚’è¿”ã—ã€ä»–ã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`
                                },
                                {
                                    inlineData: {
                                        mimeType: 'image/jpeg',
                                        data: base64Image
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 200
                        }
                    })
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                    const text = data.candidates[0].content.parts[0].text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);

                    if (jsonMatch) {
                        const result = JSON.parse(jsonMatch[0]);
                        const rect = capturedCanvas.getBoundingClientRect();

                        state.perspectivePoints = result.corners.map(c => ({
                            x: c.x * rect.width,
                            y: c.y * rect.height
                        }));

                        updatePerspectiveOverlay();
                        showStatus('âœ“ åœ°é¢ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„');
                    } else {
                        throw new Error('Invalid response format');
                    }
                } else {
                    throw new Error('No response from API');
                }
            } catch (err) {
                console.error('AI detection error:', err);
                showStatus('æ¤œå‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§èª¿æ•´ã—ã¦ãã ã•ã„', true);
            }
        }

        function applyPerspectiveTransform() {
            const srcPoints = state.perspectivePoints;
            const rect = capturedCanvas.getBoundingClientRect();
            const scaleX = capturedCanvas.width / rect.width;
            const scaleY = capturedCanvas.height / rect.height;

            // ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«å¤‰æ›
            const src = srcPoints.map(p => ({
                x: p.x * scaleX,
                y: p.y * scaleY
            }));

            // å‡ºåŠ›ã‚µã‚¤ã‚º
            const outputSize = 800;
            transformCanvas.width = outputSize;
            transformCanvas.height = outputSize;

            // é€è¦–å¤‰æ›è¡Œåˆ—ã‚’è¨ˆç®—
            const dst = [
                { x: 0, y: 0 },
                { x: outputSize, y: 0 },
                { x: outputSize, y: outputSize },
                { x: 0, y: outputSize }
            ];

            const matrix = getPerspectiveTransform(src, dst);
            applyTransformToCanvas(capturedCanvas, transformCanvas, matrix, outputSize);

            // çµæœã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            state.capturedImage = transformCanvas.toDataURL('image/jpeg', 0.9);
            previewImage.src = state.capturedImage;
            document.getElementById('previewTitle').textContent = 'ãƒ‘ãƒ¼ã‚¹è£œæ­£çµæœ';
            previewModal.classList.add('show');

            perspectiveOverlay.classList.remove('active');
            showStatus('ãƒ‘ãƒ¼ã‚¹è£œæ­£ã‚’é©ç”¨ã—ã¾ã—ãŸ');
        }

        // é€è¦–å¤‰æ›è¡Œåˆ—ã‚’è¨ˆç®—
        function getPerspectiveTransform(src, dst) {
            const A = [];
            const b = [];

            for (let i = 0; i < 4; i++) {
                const sx = src[i].x, sy = src[i].y;
                const dx = dst[i].x, dy = dst[i].y;
                A.push([sx, sy, 1, 0, 0, 0, -dx * sx, -dx * sy]);
                A.push([0, 0, 0, sx, sy, 1, -dy * sx, -dy * sy]);
                b.push(dx);
                b.push(dy);
            }

            // ã‚¬ã‚¦ã‚¹ã®æ¶ˆå»æ³•ã§è§£ã
            const h = solveLinearSystem(A, b);
            h.push(1);

            return h;
        }

        function solveLinearSystem(A, b) {
            const n = A.length;
            const augmented = A.map((row, i) => [...row, b[i]]);

            for (let col = 0; col < n; col++) {
                let maxRow = col;
                for (let row = col + 1; row < n; row++) {
                    if (Math.abs(augmented[row][col]) > Math.abs(augmented[maxRow][col])) {
                        maxRow = row;
                    }
                }
                [augmented[col], augmented[maxRow]] = [augmented[maxRow], augmented[col]];

                for (let row = col + 1; row < n; row++) {
                    const factor = augmented[row][col] / augmented[col][col];
                    for (let j = col; j <= n; j++) {
                        augmented[row][j] -= factor * augmented[col][j];
                    }
                }
            }

            const x = new Array(n).fill(0);
            for (let i = n - 1; i >= 0; i--) {
                x[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    x[i] -= augmented[i][j] * x[j];
                }
                x[i] /= augmented[i][i];
            }

            return x;
        }

        function applyTransformToCanvas(srcCanvas, dstCanvas, h, size) {
            const srcCtx = srcCanvas.getContext('2d');
            const dstCtx = dstCanvas.getContext('2d');
            const srcData = srcCtx.getImageData(0, 0, srcCanvas.width, srcCanvas.height);
            const dstData = dstCtx.createImageData(size, size);

            for (let dy = 0; dy < size; dy++) {
                for (let dx = 0; dx < size; dx++) {
                    // é€†å¤‰æ›ã§å…ƒç”»åƒã®åº§æ¨™ã‚’æ±‚ã‚ã‚‹
                    const denom = h[6] * dx + h[7] * dy + h[8];
                    const sx = (h[0] * dx + h[1] * dy + h[2]) / denom;
                    const sy = (h[3] * dx + h[4] * dy + h[5]) / denom;

                    if (sx >= 0 && sx < srcCanvas.width && sy >= 0 && sy < srcCanvas.height) {
                        const srcX = Math.floor(sx);
                        const srcY = Math.floor(sy);
                        const srcIdx = (srcY * srcCanvas.width + srcX) * 4;
                        const dstIdx = (dy * size + dx) * 4;

                        dstData.data[dstIdx] = srcData.data[srcIdx];
                        dstData.data[dstIdx + 1] = srcData.data[srcIdx + 1];
                        dstData.data[dstIdx + 2] = srcData.data[srcIdx + 2];
                        dstData.data[dstIdx + 3] = srcData.data[srcIdx + 3];
                    }
                }
            }

            dstCtx.putImageData(dstData, 0, 0);
        }

        // ========== ç”»åƒä¿å­˜ ==========
        function closePreview() {
            previewModal.classList.remove('show');
            if (state.isCapturing) {
                initCamera();
            }
        }

        function saveImage() {
            processCanvas.width = 800;
            processCanvas.height = 800;

            const img = new Image();
            img.onload = () => {
                processCtx.drawImage(img, 0, 0, 800, 800);
                const processed = detectCracks(processCanvas);

                state.cells[state.selectedCell] = {
                    original: state.capturedImage,
                    processed: processed.imageData,
                    crackPercent: processed.crackPercent,
                    timestamp: new Date().toISOString(),
                    note: '',
                    rating: getRatingFromPercent(processed.crackPercent)
                };

                previewModal.classList.remove('show');
                createGrid();
                updateSpreadsheet();
                autoSelectNextCell();
                initCamera();
                showStatus(`ã‚»ãƒ« ${state.selectedCell} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            };
            img.src = state.capturedImage;
        }

        // ========== ã‚¯ãƒ©ãƒƒã‚¯æ¤œå‡º ==========
        function detectCracks(canvas) {
            const width = canvas.width;
            const height = canvas.height;
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            const gray = new Uint8Array(width * height);
            const edges = new Uint8Array(width * height);

            for (let i = 0; i < data.length; i += 4) {
                gray[i / 4] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            }

            let crackPixels = 0;
            const threshold = state.settings.crackThreshold;

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = y * width + x;
                    const gx = -gray[idx - width - 1] + gray[idx - width + 1]
                             - 2 * gray[idx - 1] + 2 * gray[idx + 1]
                             - gray[idx + width - 1] + gray[idx + width + 1];
                    const gy = -gray[idx - width - 1] - 2 * gray[idx - width] - gray[idx - width + 1]
                             + gray[idx + width - 1] + 2 * gray[idx + width] + gray[idx + width + 1];
                    const magnitude = Math.sqrt(gx * gx + gy * gy);

                    if (magnitude > threshold) {
                        edges[idx] = 255;
                        crackPixels++;
                    }
                }
            }

            for (let i = 0; i < edges.length; i++) {
                if (edges[i] === 255) {
                    const pi = i * 4;
                    data[pi] = 255;
                    data[pi + 1] = 50;
                    data[pi + 2] = 50;
                }
            }

            ctx.putImageData(imageData, 0, 0);
            return {
                imageData: canvas.toDataURL('image/jpeg', 0.8),
                crackPercent: (crackPixels / (width * height)) * 100
            };
        }

        function getRatingFromPercent(percent) {
            if (percent >= 5) return 'è¦å¯¾å¿œ';
            if (percent >= 2) return 'çµŒéè¦³å¯Ÿ';
            return 'è‰¯å¥½';
        }

        // ========== ã‚°ãƒªãƒƒãƒ‰ ==========
        function createGrid() {
            const crackMap = document.getElementById('crackMap');
            crackMap.innerHTML = '';
            crackMap.style.gridTemplateColumns = `repeat(${state.gridSize}, 1fr)`;

            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    const key = `${row}-${col}`;
                    const cellData = state.cells[key];

                    if (cellData) {
                        cell.innerHTML = `
                            <img src="${cellData.processed}" alt="crack">
                            <span class="cell-label">${row+1}-${col+1}</span>
                            <span class="crack-info">${cellData.crackPercent.toFixed(1)}%</span>
                        `;
                    } else {
                        cell.innerHTML = `
                            <span class="placeholder">+</span>
                            <span class="cell-label">${row+1}-${col+1}</span>
                        `;
                    }

                    cell.addEventListener('click', () => selectCell(row, col));
                    crackMap.appendChild(cell);
                }
            }
        }

        function selectCell(row, col) {
            document.querySelectorAll('.map-cell').forEach(c => c.classList.remove('selected'));
            const key = `${row}-${col}`;
            state.selectedCell = key;
            const cell = document.querySelector(`.map-cell[data-row="${row}"][data-col="${col}"]`);
            if (cell) cell.classList.add('selected');
            showStatus(`ã‚»ãƒ« ${row+1}-${col+1} ã‚’é¸æŠä¸­`);
        }

        function autoSelectNextCell() {
            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    if (!state.cells[`${row}-${col}`]) {
                        selectCell(row, col);
                        return;
                    }
                }
            }
        }

        // ========== ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ ==========
        function updateSpreadsheet() {
            const tbody = document.getElementById('spreadsheetBody');
            tbody.innerHTML = '';
            let rowNum = 1;

            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const key = `${row}-${col}`;
                    const cellData = state.cells[key];
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td class="row-header">${rowNum++}</td>
                        <td>${row + 1}-${col + 1}</td>
                        <td>${cellData ? '<span class="status-badge captured">æ’®å½±æ¸ˆ</span>' : '<span class="status-badge empty">æœªæ’®å½±</span>'}</td>
                        <td>${cellData ? `<img src="${cellData.processed}" class="thumbnail" onclick="showImagePreview('${key}')">` : '-'}</td>
                        <td class="cell-crack ${cellData ? (cellData.crackPercent >= 5 ? 'high' : cellData.crackPercent >= 2 ? 'medium' : 'low') : ''}">${cellData ? cellData.crackPercent.toFixed(2) : '-'}</td>
                        <td>
                            <select class="cell-input" onchange="updateRating('${key}', this.value)">
                                <option value="">-</option>
                                <option value="è‰¯å¥½" ${cellData?.rating === 'è‰¯å¥½' ? 'selected' : ''}>è‰¯å¥½</option>
                                <option value="çµŒéè¦³å¯Ÿ" ${cellData?.rating === 'çµŒéè¦³å¯Ÿ' ? 'selected' : ''}>çµŒéè¦³å¯Ÿ</option>
                                <option value="è¦å¯¾å¿œ" ${cellData?.rating === 'è¦å¯¾å¿œ' ? 'selected' : ''}>è¦å¯¾å¿œ</option>
                            </select>
                        </td>
                        <td><input type="text" class="cell-input" placeholder="ãƒ¡ãƒ¢..." value="${cellData?.note || ''}" onchange="updateNote('${key}', this.value)"></td>
                        <td>${cellData?.timestamp ? new Date(cellData.timestamp).toLocaleString('ja-JP', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '-'}</td>
                    `;

                    tbody.appendChild(tr);
                }
            }

            updateSummary();
        }

        function updateRating(key, value) {
            if (state.cells[key]) state.cells[key].rating = value;
        }

        function updateNote(key, value) {
            if (state.cells[key]) state.cells[key].note = value;
        }

        function updateSummary() {
            const values = Object.values(state.cells);
            const count = values.length;

            document.getElementById('summaryTotal').textContent = count;

            if (count === 0) {
                document.getElementById('summaryAvg').textContent = '-';
                document.getElementById('summaryMax').textContent = '-';
                document.getElementById('summaryMin').textContent = '-';
                return;
            }

            const percents = values.map(v => v.crackPercent);
            document.getElementById('summaryAvg').textContent = (percents.reduce((a, b) => a + b, 0) / count).toFixed(1) + '%';
            document.getElementById('summaryMax').textContent = Math.max(...percents).toFixed(1) + '%';
            document.getElementById('summaryMin').textContent = Math.min(...percents).toFixed(1) + '%';
        }

        function showImagePreview(key) {
            if (state.cells[key]) {
                previewImage.src = state.cells[key].processed;
                document.getElementById('previewTitle').textContent = `ã‚»ãƒ« ${key}`;
                document.getElementById('saveBtn').style.display = 'none';
                document.getElementById('retakeBtn').textContent = 'é–‰ã˜ã‚‹';
                previewModal.classList.add('show');
            }
        }

        // ========== CSVæ©Ÿèƒ½ ==========
        function exportCSV() {
            const rows = [['ã‚»ãƒ«ä½ç½®', 'è¡Œ', 'åˆ—', 'çŠ¶æ…‹', 'ã‚¯ãƒ©ãƒƒã‚¯ç‡(%)', 'è©•ä¾¡', 'ãƒ¡ãƒ¢', 'æ’®å½±æ—¥æ™‚']];

            for (let row = 0; row < state.gridSize; row++) {
                for (let col = 0; col < state.gridSize; col++) {
                    const key = `${row}-${col}`;
                    const cellData = state.cells[key];
                    rows.push([
                        `${row + 1}-${col + 1}`,
                        row + 1,
                        col + 1,
                        cellData ? 'æ’®å½±æ¸ˆ' : 'æœªæ’®å½±',
                        cellData ? cellData.crackPercent.toFixed(2) : '',
                        cellData?.rating || '',
                        `"${(cellData?.note || '').replace(/"/g, '""')}"`,
                        cellData?.timestamp ? new Date(cellData.timestamp).toLocaleString('ja-JP') : ''
                    ]);
                }
            }

            const blob = new Blob(['\uFEFF' + rows.map(r => r.join(',')).join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.download = `crack_data_${new Date().toISOString().slice(0, 10)}.csv`;
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        function importCSV(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const lines = event.target.result.split('\n').filter(l => l.trim());
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length < 6) continue;
                    const [rowStr, colStr] = cols[0].split('-');
                    const key = `${parseInt(rowStr) - 1}-${parseInt(colStr) - 1}`;
                    if (state.cells[key]) {
                        state.cells[key].rating = cols[5] || state.cells[key].rating;
                        state.cells[key].note = cols[6]?.replace(/^"|"$/g, '') || '';
                    }
                }
                updateSpreadsheet();
                showStatus('CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function clearData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                state.cells = {};
                createGrid();
                updateSpreadsheet();
                selectCell(0, 0);
                showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
        function showStatus(message, isError = false, showSpinner = false) {
            statusBar.innerHTML = `
                ${showSpinner ? '<div class="spinner"></div>' : ''}
                <span style="color: ${isError ? '#e94560' : '#888'}">${message}</span>
            `;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.showImagePreview = showImagePreview;
        window.updateRating = updateRating;
        window.updateNote = updateNote;

        // åˆæœŸåŒ–
        init();
    </script>
</body>
</html>
